function defaultScene(){return{things:[new Plane(new Vector(0,1,0),0,Surfaces.checkerboard),new Sphere(new Vector(0,1,-.25),1,Surfaces.shiny),new Sphere(new Vector(-1,.5,1.5),.5,Surfaces.shiny)],lights:[{pos:new Vector(-2,2.5,0),color:new Color(.49,.07,.07)},{pos:new Vector(1.5,2.5,1.5),color:new Color(.07,.07,.49)},{pos:new Vector(1.5,2.5,-1.5),color:new Color(.07,.49,.071)},{pos:new Vector(0,3.5,0),color:new Color(.21,.21,.35)}],camera:new Camera(new Vector(3,2,4),new Vector(-1,.5,0))}}function exec(){var r=document.createElement("canvas");r.width=256,r.height=256,document.getElementById("hello").appendChild(r);var t=r.getContext("2d"),o=new RayTracer;return o.render(defaultScene(),t,256,256)}var Vector=function(){function r(r,t,o){this.x=r,this.y=t,this.z=o}return r.times=function(t,o){return new r(t*o.x,t*o.y,t*o.z)},r.minus=function(t,o){return new r(t.x-o.x,t.y-o.y,t.z-o.z)},r.plus=function(t,o){return new r(t.x+o.x,t.y+o.y,t.z+o.z)},r.dot=function(r,t){return r.x*t.x+r.y*t.y+r.z*t.z},r.mag=function(r){return Math.sqrt(r.x*r.x+r.y*r.y+r.z*r.z)},r.norm=function(t){var o=r.mag(t),e=0===o?1/0:1/o;return r.times(e,t)},r.cross=function(t,o){return new r(t.y*o.z-t.z*o.y,t.z*o.x-t.x*o.z,t.x*o.y-t.y*o.x)},r}(),Color=function(){function r(r,t,o){this.r=r,this.g=t,this.b=o}return r.scale=function(t,o){return new r(t*o.r,t*o.g,t*o.b)},r.plus=function(t,o){return new r(t.r+o.r,t.g+o.g,t.b+o.b)},r.times=function(t,o){return new r(t.r*o.r,t.g*o.g,t.b*o.b)},r.toDrawingColor=function(r){var t=function(r){return r>1?1:r};return{r:Math.floor(255*t(r.r)),g:Math.floor(255*t(r.g)),b:Math.floor(255*t(r.b))}},r.white=new r(1,1,1),r.grey=new r(.5,.5,.5),r.black=new r(0,0,0),r.background=r.black,r.defaultColor=r.black,r}(),Camera=function(){function r(r,t){this.pos=r;var o=new Vector(0,-1,0);this.forward=Vector.norm(Vector.minus(t,this.pos)),this.right=Vector.times(1.5,Vector.norm(Vector.cross(this.forward,o))),this.up=Vector.times(1.5,Vector.norm(Vector.cross(this.forward,this.right)))}return r}(),Sphere=function(){function r(r,t,o){this.center=r,this.surface=o,this.radius2=t*t}return r.prototype.normal=function(r){return Vector.norm(Vector.minus(r,this.center))},r.prototype.intersect=function(r){var t=Vector.minus(this.center,r.start),o=Vector.dot(t,r.dir),e=0;if(o>=0){var n=this.radius2-(Vector.dot(t,t)-o*o);n>=0&&(e=o-Math.sqrt(n))}return 0===e?null:{thing:this,ray:r,dist:e}},r}(),Plane=function(){function r(r,t,o){this.surface=o,this.normal=function(t){return r},this.intersect=function(o){var e=Vector.dot(r,o.dir);if(e>0)return null;var n=(Vector.dot(r,o.start)+t)/-e;return{thing:this,ray:o,dist:n}}}return r}(),Surfaces;!function(r){r.shiny={diffuse:function(r){return Color.white},specular:function(r){return Color.grey},reflect:function(r){return.7},roughness:250},r.checkerboard={diffuse:function(r){return(Math.floor(r.z)+Math.floor(r.x))%2!==0?Color.white:Color.black},specular:function(r){return Color.white},reflect:function(r){return(Math.floor(r.z)+Math.floor(r.x))%2!==0?.1:.7},roughness:150}}(Surfaces||(Surfaces={}));var RayTracer=function(){function r(){this.maxDepth=5}return r.prototype.intersections=function(r,t){var o=+(1/0),e=void 0;for(var n in t.things){var i=t.things[n].intersect(r);null!=i&&i.dist<o&&(e=i,o=i.dist)}return e},r.prototype.testRay=function(r,t){var o=this.intersections(r,t);return null!=o?o.dist:void 0},r.prototype.traceRay=function(r,t,o){var e=this.intersections(r,t);return void 0===e?Color.background:this.shade(e,t,o)},r.prototype.shade=function(r,t,o){var e=r.ray.dir,n=Vector.plus(Vector.times(r.dist,e),r.ray.start),i=r.thing.normal(n),c=Vector.minus(e,Vector.times(2,Vector.times(Vector.dot(i,e),i))),u=Color.plus(Color.background,this.getNaturalColor(r.thing,n,i,c,t)),s=o>=this.maxDepth?Color.grey:this.getReflectionColor(r.thing,n,i,c,t,o);return Color.plus(u,s)},r.prototype.getReflectionColor=function(r,t,o,e,n,i){return Color.scale(r.surface.reflect(t),this.traceRay({start:t,dir:e},n,i+1))},r.prototype.getNaturalColor=function(r,t,o,e,n){var i=this,c=function(c,u){var s=Vector.minus(u.pos,t),a=Vector.norm(s),l=i.testRay({start:t,dir:a},n),f=void 0===l?!1:l<=Vector.mag(s);if(f)return c;var h=Vector.dot(a,o),d=h>0?Color.scale(h,u.color):Color.defaultColor,p=Vector.dot(a,Vector.norm(e)),g=p>0?Color.scale(Math.pow(p,r.surface.roughness),u.color):Color.defaultColor;return Color.plus(c,Color.plus(Color.times(r.surface.diffuse(t),d),Color.times(r.surface.specular(t),g)))};return n.lights.reduce(c,Color.defaultColor)},r.prototype.render=function(r,t,o,e){for(var n=function(r,t,n){var i=function(r){return(r-o/2)/2/o},c=function(r){return-(r-e/2)/2/e};return Vector.norm(Vector.plus(n.forward,Vector.plus(Vector.times(i(r),n.right),Vector.times(c(t),n.up))))},i=0;e>i;i++)for(var c=0;o>c;c++){var u=this.traceRay({start:r.camera.pos,dir:n(c,i,r.camera)},r,0),s=Color.toDrawingColor(u);t.fillStyle="rgb("+String(s.r)+", "+String(s.g)+", "+String(s.b)+")",t.fillRect(c,i,c+1,i+1)}},r}();exec();